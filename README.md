# BTC Up/Down

dApp-демо, в котором игрок делает ставку на то, вырастет или упадёт цена BTC через 1 минуту. Смарт‑контракт собирает ставки двух сторон, фиксирует цену, рассчитывает победителей и удерживает 1 % комиссии. Интерфейс написан на чистом HTML/JS (hosted ASP.NET), а отдельный бот следит за фазами раундов, чтобы автоматически дергать `progress()`.

## Компоненты репозитория

| Путь        | Назначение |
|------------|------------|
| `chain/`   | Hardhat‑проект. Контракт `BtcUpDown.sol`, скрипты деплоя и тесты. |
| `web/`     | ASP.NET Minimal API, отдающая статический фронт из `wwwroot/`. |
| `bot/`     | Node.js‑скрипт, который по RPC вызывает `progress()` и продвигает раунды. |
| `package.json` (root) | Оркестратор: `start:local` запускает узел Hardhat, деплой, веб и бота в одном процессе. |

## Кратко о смарт‑контракте

- Раунд имеет 3 фазы: `BET_DURATION` (приём ставок), `SETTLE_DELAY` (ожидание settle) и `NEXT_DELAY` (пауза перед новым раундом). В демо тайминги сокращены до 10 / 20 / 5 секунд для быстрых тестов.
- Используется Chainlink AggregatorV3: если деплой идёт в Sepolia, берётся реальный BTC/USDT фид `0x1b44…`.
- Ставки `Side.UP` и `Side.DOWN` копятся в отдельных пулах. При `progress()` контракт фиксирует цену на lock и settle; ничья или пустая сторона → полный рефанд. Иначе победители делят общий пул минус 1 % комиссии.
- Победители вызывают `claim(rid)` независимо от текущего раунда. Контракт хранит счётчик `winsCount` и накопленную комиссию, которую владелец может вывести через `withdrawFees()`.
- Простая защита от реентранси (lock‑флаг), минимальная ставка — `0.00002 ether`.

## Фронтенд

- Показ текущего раунда: таймеры, цены lock/settle, банк, доли сторон, комиссия.
- Кнопки ставок, `claim`, ручной `progress()` и админская кнопка вывода комиссии.
- Таблица топ‑10 победителей строится по событиям `Bet`/`Claimed`.
- При подключении MetaMask предлагается переключиться на сеть 31337 (локальный Hardhat). Адрес контракта и ABI берутся из `web/wwwroot/contractConfig.json`, который генерирует скрипт деплоя.

## Бот

`bot/bot.js` читает конфиг, подключается к RPC и каждые 7 секунд проверяет фазу: если пора lock/settle/стартовать новый раунд — вызывает `progress()`. Переменные окружения:

```
RPC_URL=http://127.0.0.1:8545
LOCAL_PRIVATE_KEY=<приватник учётки hardhat, например 0xac09...>
```

Для Sepolia можно использовать `SEPOLIA_RPC` и `SEPOLIA_PRIVATE_KEY`.

## Быстрый старт (локальная демо-схема)

1. Установи Node.js ≥ 18, npm и .NET 8 SDK.
2. В одном терминале в корне выполни:
   ```bash
   npm run start:local
   ```
   Скрипт сделает `npm install`, поднимет `npx hardhat node`, задеплоит контракт, соберёт `contractConfig.json`, запустит ASP.NET фронт и бота. Всё идёт в **одном** терминале через `concurrently`; держи его открытым, чтобы процессы не упали.
3. Открой `http://localhost:5000`, нажми «Подключить кошелёк», разреши MetaMask использовать сеть `Hardhat Localhost (31337)` и делай ставки.

Остановка: Ctrl+C в терминале. При следующем запуске `start:local` автоматически очистит артефакты и перезапустит все процессы.

## Ручной запуск

Если нужно поднять сервисы по отдельности:

```bash
# Терминал 1 — RPC
cd chain
npx hardhat node

# Терминал 2 — деплой на localhost, генерирует web/wwwroot/contractConfig.json
npx hardhat run scripts/deploy.js --network localhost

# Терминал 3 — фронтенд
cd web
dotnet run

# Терминал 4 — бот (предварительно задайте RPC_URL и LOCAL_PRIVATE_KEY)
cd bot
node bot.js
```

## MetaMask: подключение и тестовые ETH

1. Установи расширение MetaMask и создай/разблокируй кошелёк.
2. Добавь сеть Hardhat (если дашборд не предложил переключиться сам):
   - RPC: `http://127.0.0.1:8545`
   - Chain ID: `31337`
   - Currency: `ETH`
   - Name: `Hardhat Localhost`
3. Получение виртуальных денег (локальная сеть):
   - После запуска `npx hardhat node` в терминале печатаются 20 аккаунтов с приватными ключами, каждый с балансом 10000 ETH.
   - Скопируй любой приватный ключ и импортируй аккаунт в MetaMask → сразу увидишь 10000 тестовых ETH.
   - Если хочешь отдельный кошелёк, отправь на него часть средств из импортированного аккаунта через MetaMask.
4. Подключение к dApp:
   - Перейди на `http://localhost:5000`.
   - Нажми «Подключить кошелёк» → подтвердить сеть 31337 → разрешить доступ.
   - Делай ставки, нажимай `progress()`/`claim` при необходимости; бот на локалке сам двигает фазы.

Для тестнета Sepolia нужны собственные RPC/ключи и тестовый эфир с любого публичного faucet; после деплоя обнови `web/wwwroot/contractConfig.json` скриптом `deploy.js`.

## Тесты

В `chain/test/BtcUpDown.js` покрыты два сценария: победа стороны с подсчётом комиссии, и рефанд при неизменной цене. Запуск:

```bash
cd chain
npx hardhat test
```

## Полезные команды

- `npm run clean` — убивает `hardhat`, `dotnet`, `node` процессы и чистит артефакты (`chain/artifacts`, `web/bin`, `node_modules`, и т.п.).
- `cd chain && npx hardhat compile` — быстрая перекомпиляция контракта.
- `cd chain && npx hardhat run scripts/deploy.js --network sepolia` — деплой в тестовую сеть (нужны `SEPOLIA_RPC` + `SEPOLIA_PRIVATE_KEY`).

## FAQ

- **Где менять тайминги раундов?** В `chain/contracts/BtcUpDown.sol` (константы `BET_DURATION`, `SETTLE_DELAY`, `NEXT_DELAY`). Не забудь пересобрать контракт и заново задеплоить.
- **Что делать, если фронт не видит контракт?** Убедись, что `web/wwwroot/contractConfig.json` соответствует текущей сети и адрес не `0x5FbD...` при работе вне локальной 31337. Скрипт деплоя перезапишет файл автоматически.
